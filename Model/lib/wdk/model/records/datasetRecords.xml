<wdkModel>

  <constant name="datasetRecordDisplayName" includeProjects="ClinEpiDB,AllClinEpiDB">Study</constant>
  <constant name="datasetRecordDisplayNamePlural" includeProjects="ClinEpiDB,AllClinEpiDB">Studies</constant>

  <constant name="datasetRecordDisplayName" excludeProjects="ClinEpiDB,AllClinEpiDB">Data Set</constant>
  <constant name="datasetRecordDisplayNamePlural" excludeProjects="ClinEpiDB,AllClinEpiDB">Data Sets</constant>

  <recordClassSet name="DatasetRecordClasses">


<!-- ============== a class with only one member.  the primary key is always 111 ===========  -->

   <recordClass name="DatasetReleaseNotes" urlName="dataset-release-notes" displayName="Data Set Release Notes">
      <primaryKey aliasPluginClassName="org.gusdb.wdk.model.record.GenericRecordPrimaryKeyAliasPlugin">
        <columnRef>release_notes_id</columnRef>
      </primaryKey>

      <idAttribute name="primary_key" displayName="Release Notes ID">
        <text>
          <![CDATA[
            $$release_notes_id$$
          ]]>
        </text>
      </idAttribute>

      <table name="ReleaseNotes"
             displayName="Dataset Release Notes"
             queryRef="DatasetReleaseNotesTables.ReleaseNotes">
        <columnAttribute name="build_number" displayName="VEuPathDB Build #"/>
        <columnAttribute name="release_date" displayName="Release Date"/>
        <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
        <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
        <columnAttribute name="note" displayName="Notes"/>
      </table>

    </recordClass>

<!-- ======================================= DATA SETS =========================================================== -->

    <!-- This recordClass shows as "Study" in ClinEpi record page with some client rendering magic, since includeProjects cannot be used  -->
   <recordClass name="DatasetRecordClass" displayName="%%datasetRecordDisplayName%%" displayNamePlural="%%datasetRecordDisplayNamePlural%%" urlName="dataset">
           <!-- description="A Data Set describes the information we acquired from a data provider. For some data sets we process the information to expose the analyzed result in our site (searches, GBrowse tracks etc)." -->

     <testParamValues >
       <paramValue name="dataset_id">1</paramValue>
     </testParamValues>

      <!-- primary key definition
           NOTE:  the name here is from apidbtuning.DatasetPresenter NOT apidb.datasource
      -->
      <primaryKey aliasPluginClassName="org.gusdb.wdk.model.record.GenericRecordPrimaryKeyAliasPlugin">
          <columnRef>dataset_id</columnRef>
      </primaryKey>

      <idAttribute name="primary_key" displayName="Data Set" excludeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR"
                   help="Click a data set to go to the full data set record">
          <text>
              <![CDATA[ $$display_name$$ ]]>
          </text>
      </idAttribute>

      <idAttribute name="primary_key" displayName="Study" includeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR"
                   help="Click a study to go to the full study record">
          <text>
              <![CDATA[ $$display_name$$ ]]>
          </text>
      </idAttribute>

      <!-- =============================================================== -->
      <!--   Reporters -->
      <!-- =============================================================== -->

          <reporter name="attributesTabular" displayName="Summary - tab delimited" scopes="results"
                    implementation="org.gusdb.wdk.model.report.reporter.AttributesTabularReporter">
             <property name="page_size">500</property>
          </reporter>
          <reporter name="tableTabular" displayName="%%tableReporterDisplayName%%" scopes="results" excludeProjects="EuPathDB"
                    implementation="org.gusdb.wdk.model.report.reporter.TableTabularReporter">
             <property name="page_size">1000000</property>           <!-- huge page size to force no paging  -->
          </reporter>

          <reporter name="fullRecord" displayName="%%fullReporterDisplayName%%" scopes="record"
                    implementation="org.gusdb.wdk.model.report.reporter.FullRecordReporter">
          </reporter>

          <reporter name="xml"  displayName="XML: choose from columns and/or tables" scopes=""
                   implementation="org.gusdb.wdk.model.report.reporter.XMLReporter">
          </reporter>
          <reporter name="json"  displayName="json: choose from columns and/or tables" scopes=""
                    implementation="org.gusdb.wdk.model.report.reporter.JSONReporter">
          </reporter>

      <!-- =============================================================== -->
      <!--   Filters -->
      <!-- =============================================================== -->


      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->


       <attributeQueryRef ref="DatasetAttributes.Organisms"  excludeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
         <columnAttribute  name="organism_prefix" displayName="Organism(s) (source or reference)"
                          help="The 'source' is the organism used to generate the samples that were analyzed to produce this dataset. The 'reference' is the genome that the data were aligned to. For functional datasets, the source may differ from the reference."/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.Projects"  includeProjects="EuPathDB">
         <columnAttribute  name="project_id" displayName="VEuPathDB Project"/>
       </attributeQueryRef>
<!--

       <attributeQueryRef ref="DatasetAttributes.Category">
         <columnAttribute name="category" displayName="Category" inReportMaker="false"
                          help= "Datasets are assigned to categories based on the biological attributes of the data." />
       </attributeQueryRef>
-->

       <attributeQueryRef ref="DatasetAttributes.NewCategory" excludeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
         <columnAttribute name="newcategory" displayName="Category" inReportMaker="false"
                          help= "Datasets are assigned to categories based on the biological attributes of the data." />
       </attributeQueryRef>

<!--
      <attributeQueryRef ref="DatasetAttributes.ExpTechnique">
         <columnAttribute name="exp_technique" displayName="Technology" help="The method or process used to generate the data (functional datasets) or the type of association that VEuPathDB made to the data (e.g. link outs to other data bases.)"/>
       </attributeQueryRef>
-->

       <attributeQueryRef ref="DatasetAttributes.DatasetDigest" includeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
         <columnAttribute name="dataset_sha1_digest" internal="true"/>
         <columnAttribute name="dataset_display_name" internal="true"/>
         <linkAttribute name="bulk_download_url" displayName="Download" inReportMaker="false">
              <displayText>
                <![CDATA[ <i class="fa fa-download"></i> ]]>
              </displayText>
              <url>
                <![CDATA[ @WEBAPP_BASE_URL@/downloads/release-%%buildNumber%%/$$dataset_sha1_digest$$ ]]>
              </url>
         </linkAttribute>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.ClinepiStudyAttributes" includeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
         <columnAttribute name="project_availability" internal="true"/>
         <columnAttribute name="study_access" displayName="Study Accessibility"
           help="Some studies require that the user requests approval to access certain functionality (they will be prompted when attempting the action):
                 if 'controlled', to download; if 'protected', to access specific search results and download; if 'private', to run a search or analysis and download.
                 If a study is classified as 'limited', it will behave as 'controlled' when the user is logged in, and as 'protected' for a guest user. "/>
         <columnAttribute name="policy_url" internal="true"/>
         <columnAttribute name="card_headline" internal="true"/>
         <columnAttribute name="card_points" internal="true"/>
         <columnAttribute name="card_questions" displayName="Searches"/>
         <columnAttribute name="request_protection_level" internal="true"/>
         <columnAttribute name="request_access_fields" internal="true"/>
         <columnAttribute name="request_email" internal="true"/>
         <columnAttribute name="request_email_bcc" internal="true"/>
         <columnAttribute name="request_email_body" internal="true"/>
         <columnAttribute name="request_needs_approval" internal="true"/>
       </attributeQueryRef>


       <attributeQueryRef ref="DatasetAttributes.MicrobiomeStudyAttributes" includeProjects="MicrobiomeDB">
         <columnAttribute name="study_categories" displayName="Category"/>
       </attributeQueryRef>



       <attributeQueryRef ref="DatasetAttributes.StudyCharacteristic" includeProjects="ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
         <columnAttribute name="disease" displayName="Disease"/>
         <columnAttribute name="sex" displayName="Sex"/>
         <columnAttribute name="Sample_Type" displayName="Sample Type"/>
         <columnAttribute name="Participant_Type" displayName="Population included"/>
         <columnAttribute name="Study_Type" displayName="Investigation Type"/>
         <columnAttribute name="Study_Design" displayName="Study Design"/>
         <columnAttribute name="Country" displayName="Country"/>
         <columnAttribute name="Years" displayName="Years"/>
         <columnAttribute name="HH_count" displayName="Households" type="number"/>
         <columnAttribute name="Part_count" displayName="Participants" type="number"/>
         <columnAttribute name="Obser_count" displayName="Observations" type="number"/>
         <columnAttribute name="Samp_count" displayName="Samples" type="number"/>
         <columnAttribute name="AdditionalData" displayName="Additional Data"/>
         <columnAttribute name="Age" displayName="Age"/>
         <columnAttribute name="WHO" displayName="WHO indicator subdomain"/>
         <columnAttribute name="ProjectName" displayName="Project Name"/>
       </attributeQueryRef>



       <attributeQueryRef ref="DatasetAttributes.All">
         <columnAttribute name="dataset_name" internal="true" displayName="Data Set Name" help="Name of the dataset."/>
         <columnAttribute name="dataset_name_pattern" internal="true" inReportMaker="false"/>
         <columnAttribute name="display_name" internal="true" displayName="Dataset Name" removable="false"/>
         <columnAttribute name="short_display_name" internal="true"/>
         <columnAttribute name="version" displayName="Data Set Version"  internal="true" includeProjects="MicrobiomeDB,ClinEpiDB,AllClinEpiDB,EuPathDB"/>
          <columnAttribute name="version" displayName="Data Set Version" help="The data set provider's version number or publication date, from the site the data was acquired. In the rare case neither is available, the download date." excludeProjects="MicrobiomeDB,ClinEpiDB,AllClinEpiDB,EuPathDB"/>
         <columnAttribute name="description" displayName="Description" sortable="false"
                          help="A full description of the dataset."/>
         <columnAttribute name="protocol" internal="true"/>
         <columnAttribute name="usage" displayName="Usage" internal="true"/>
         <columnAttribute name="caveat" displayName="Caveat" internal="true"/>
         <columnAttribute name="acknowledgement" displayName="Acknowledgement" internal="true"/>
         <columnAttribute name="is_species_scope" displayName="Is Species Scope" internal="true"/>
         <columnAttribute name="build_number_introduced" displayName="Build Number Introduced" internal="true"/>
         <columnAttribute name="type" displayName="Type" internal="true"/>
         <columnAttribute name="eupath_release" displayName="Release # / Date"
                          help="The VEuPathDB release number and date that the dataset first appeared in VEuPathDB. "/>
         <columnAttribute name="summary" displayName="Summary" sortable="false"
                          help= "A short description of the dataset."/>
         <columnAttribute name="release_policy" displayName="Release Policy" internal="true" includeProjects="MicrobiomeDB,ClinEpiDB,AllClinEpiDB"/>
         <columnAttribute name="release_policy" displayName="Release Policy" excludeProjects="MicrobiomeDB,ClinEpiDB,AllClinEpiDB"
                          help= "A request from the data provider stipulating the proper use of unpublished data. "  />
         <columnAttribute name="pmids" displayName="Publications" sortable="false"
                          help="PubMed links related to the dataset."/>
         <columnAttribute name="pmids_download" displayName="Publications" sortable="false"
                          help="PubMed links related to the dataset."/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.Contacts">
         <columnAttribute name="contact" displayName="Contact"
                          help="The person or organization that serves as a source of information concerning this dataset."/>
         <columnAttribute name="institution" displayName="Contact Institution"
                          help="The institution where the Contact is located. "/>
         <columnAttribute name="email" internal="true"/>
         <columnAttribute name="short_attribution" displayName="Short Attribution" internal="true"/>
       </attributeQueryRef>

        <attributesList summary="organism_prefix,version,eupath_release,newcategory,pmids,summary,contact" 
                        excludeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR,EuPathDB"/>

        <attributesList summary="organism_prefix,project_id,eupath_release,newcategory,pmids,summary,contact"
                        includeProjects="EuPathDB"/>

	<attributesList summary="disease,Study_Type,Study_Design,Part_count,Country,Years,study_access,card_questions"
			includeProjects="ClinEpiDB,Gates,AllClinEpiDB,ICEMR"/>

	<attributesList summary="study_categories,summary,eupath_release,card_questions"
			includeProjects="MicrobiomeDB"/>


	<!-- to add a column to link somewhere, for example pubmed publication
             <textAttribute name="" displayName="" help="">
           <text>
                 <![CDATA[
                <a href="bla">linkName</a>
                ]]>
            </text>
         </textAttribute>

OR if the linkName and or URL require access to other attributes....also how to define the same column differently for downloads vs results page

            <columnAttribute name="uniprot_id" internal="true" displayName="UniProt ID" inReportMaker="true" attributeCategory="ids"/>
            <columnAttribute name="uniprot_id_internal"  internal="true" inReportMaker="false" />
            <linkAttribute name="uniprot_link" displayName="UniProt ID" inReportMaker="false" sortable="false" attributeCategory="ids">
                <displayText>
                    <![CDATA[$$uniprot_id$$]]>
                </displayText>
                <url>
                    <![CDATA[http://www.uniprot.org/uniprot/?query=$$uniprot_id_internal$$]]>
                </url>
            </linkAttribute>

-->

  <!-- =================================================================================== -->
  <!-- TABLES ++++++++-->
  <!-- ================================================================================= -->

     <!-- =================================================================== -->
     <!-- Example Graphs ++++++++-->
     <!-- =================================================================== -->

      <table name="ExampleGraphs"
	     excludeProjects="EuPathDB,ClinEpiDB,ICEMR,Gates,AllClinEpiDB,MicrobiomeDB"
	     displayName="Example Graphs"
	     queryRef="DatasetTables.ExampleGraphs" inReportMaker="false">
  <textAttribute name="thumbnail" displayName="Preview">
              <text>
                   <![CDATA[
                   <img src="/cgi-bin/dataPlotter.pl?project_id=@PROJECT_ID@&id=$$default_graph_id$$&type=$$module$$&fmt=png&template=$$template$$&h=35&w=70&compact=1&datasetId=$$dataset_id$$&default=1"/>
                    ]]>
              </text>
            </textAttribute>
            <columnAttribute internal="true" displayName="source_id" name="source_id"/>
            <columnAttribute internal="true" displayName="project_id" name="project_id"/>
            <columnAttribute internal="true" displayName="graph_ids" name="graph_ids"/>
            <columnAttribute internal="true" displayName="module" name="module"/>
            <columnAttribute internal="true" displayName="mainOpen" name="mainOpen"/>
            <columnAttribute internal="true" displayName="dataOpen" name="dataOpen"/>
            <columnAttribute displayName="Name" name="display_name"/>
            <columnAttribute internal="true" displayName="description" name="description"/>
            <columnAttribute internal="true" displayName="x_axis" name="x_axis"/>
            <columnAttribute internal="true" displayName="y_axis" name="y_axis"/>
            <columnAttribute internal="true" displayName="has_graph_data" name="has_graph_data"/>
            <columnAttribute internal="true" displayName="has_meta_data" name="has_meta_data"/>
            <columnAttribute internal="true" displayName="meta_data_categories" name="meta_data_categories"/>
            <columnAttribute internal="true" displayName="dataset_name" name="dataset_name"/>
            <columnAttribute internal="true" displayName="dataset_id" name="dataset_id"/>
            <columnAttribute internal="true" displayName="is_graph_custom" name="is_graph_custom"/>
       <!--     <columnAttribute displayName="Summary" name="summary"/>
            <columnAttribute displayName="Attribution" name="short_attribution"/>
       -->
            <columnAttribute displayName="Assay Type" name="assay_type"/>
            <columnAttribute internal="true"  displayName="Template" name="template"/>
            <columnAttribute internal="true" displayName="DefaultGraphId" name="default_graph_id"/>
         <propertyList name="excludeFromDumper"><value>true</value></propertyList>
      </table>


        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Contacts -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Contacts"
               displayName="Principal Investigator and Collaborators"
               queryRef="DatasetTables.Contacts">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="contact_name" displayName="Investigator"/>
            <columnAttribute name="affiliation" displayName="Affiliation"/>
        </table>


	<!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- clinepi versioning download files table -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
<!--
        <table name="DownloadVersion"  includeProjects="ClinEpiDB,Gates,AllClinEpiDB,ICEMR"
               displayName="Data Download Versions"
               queryRef="DatasetTables.DownloadVersion">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>

            <columnAttribute name="version_number" inReportMaker="false" internal="true"/>

            <linkAttribute name="version_number_link" inReportMaker="false" internal="false"
                           displayName="Download link">
                 <displayText>
                    <![CDATA[ 
			     $$version_number$$                                                                                
		    ]]>
                 </displayText>
                 <url>
                    <![CDATA[ @WEBAPP_BASE_URL@/downloads/release-$$build_number$$/$$dataset_sha1_digest$$ ]]>
                 </url>
            </linkAttribute>
            <columnAttribute name="build_number" displayName="Release #"/>
            <columnAttribute name="release_date" displayName="Release Date"/>
            <columnAttribute name="note" displayName="Updates"/>
            <columnAttribute name="dataset_sha1_digest" internal="true"/>     
        </table>
-->



       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Isolates / Samples -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
<!--
        <table name="Isolates"
               displayName="Isolates / Samples"
               queryRef="DatasetTables.Isolates">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="source_id" inReportMaker="true" internal="true"/>
            <columnAttribute name="strain" inReportMaker="true" internal="true"/>
            <columnAttribute name="contact_name" inReportMaker="true" internal="true"/>
            <linkAttribute name="isolate_link" inReportMaker="false" internal="false"
                           displayName="Isolate Source Id">

                 <displayText>
                    <![CDATA[
                    $$source_id$$ - ($$strain$$) $$contact_name$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[ @WEBAPP_BASE_URL@/record/isolate/$$source_id$$ ]]>
                 </url>
            </linkAttribute>
        </table>
-->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Publications -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Publications"
               displayName="Associated Publications"
               queryRef="DatasetTables.Publications">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="pmid" displayName="Pubmed ID" internal="true"/>
            <columnAttribute name="citation" internal="true"/>


            <linkAttribute name="pubmed_link" inReportMaker="false" internal="false"
                           displayName="PubMed Link">

                 <displayText>
                    <![CDATA[
                    $$citation$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                             http://www.ncbi.nlm.nih.gov/pubmed/$$pmid$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>


        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- External Links -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="HyperLinks"
               displayName="Relevant pages at @PROJECT_ID@ and external resources"
               queryRef="DatasetTables.HyperLinks">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="text" internal="true"/>
            <columnAttribute name="url" internal="true"/>

            <linkAttribute name="hyper_link" inReportMaker="false" internal="false"
                           displayName="Links">

                 <displayText>
                    <![CDATA[
                    $$text$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                          $$url$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- History -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
<!--
        <table name="History"
               displayName="Release History"
               queryRef="DatasetTables.History">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="build" displayName="VEuPathDB Build #"/>
            <columnAttribute name="release_date" displayName="Release Date"/>
            <columnAttribute name="note" displayName="Note"/>
        </table>
-->
        <table name="GenomeHistory" excludeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR"
               displayName="Data Set Release History"
               queryRef="DatasetTables.GenomeHistory">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="build" displayName="VEuPathDB Build"/>
            <columnAttribute name="release_date" displayName="Release Date"/>
            <columnAttribute name="release_number" displayName="Release"/>
            <columnAttribute name="genome_source" displayName="Genome Source"/>
            <columnAttribute name="genome_version" displayName="Genome Version"/>
            <columnAttribute name="annotation_source" displayName="Structural Annotation Source"/>
            <columnAttribute name="annotation_version" displayName="Structural Annotation Version"/>
            <columnAttribute name="functional_annotation_source" displayName="Functional Annotation Source"/>
            <columnAttribute name="functional_annotation_version" displayName="Functional Annotation Version"/>
            <columnAttribute name="note" displayName="Note"/>
        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- References -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="References"
               displayName="Explore this dataset at @PROJECT_ID@"
               queryRef="DatasetTables.References">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="record_type" displayName="Record Type" />
            <columnAttribute name="target_type" displayName="Type of Reference"/>
            <columnAttribute name="target_name" displayName="Name"/>
        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Version   -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <table name="Version"
               displayName="Provider's Version"
	       excludeProjects="MicrobiomeDB,ClinEpiDB,ICEMR,Gates,AllClinEpiDB"
               queryRef="DatasetTables.Version">
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="organism" displayName="Reference Organism"/>
            <columnAttribute name="version" displayName="Version"/>
        </table>

<!--
      <table name="DatasetGeneTable"
             displayName="Dataset Gene Table"
             queryRef="DatasetTables.DatasetGeneTable">
        <columnAttribute name="dataset_name" displayName="Dataset Name"/>
        <columnAttribute name="source_id" displayName="Gene ID"/>
        <columnAttribute name="fdiff" displayName="Fold Difference"/>
        <columnAttribute name="min_value" displayName="Min value"/>
        <columnAttribute name="min_timepoint" displayName="Min timepoint"/>
        <columnAttribute name="max_value" displayName="Max value"/>
        <columnAttribute name="max_timepoint" displayName="Max timepoint"/>
      </table>
-->

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- request table -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<table name="AccessRequest" includeProjects="ClinEpiDB,Gates,AllClinEpiDB,ICEMR"
               displayName="Study Request Records"
               queryRef="DatasetTables.AccessRequest">
          <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
          <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
          <columnAttribute name="name" displayName="Name"/>
	  <columnAttribute name="organization" displayName="Organization"/>
	  <columnAttribute name="start_date" displayName="Date"/>
	  <columnAttribute name="purpose" displayName="Purpose"/>

        </table>



      </recordClass>
    </recordClassSet>



      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetAttributes" queryType="attribute" doNotTest="true"
              isCacheable='false'>

      <testRowCountSql>
        select count(*) from ApidbTuning.DatasetPresenter
      </testRowCountSql>

      <sqlQuery name="ExpTechnique" isCacheable="false">
         <column name="exp_technique"/>
         <column name="dataset_id"/>
         <sql>
           <![CDATA[
                   select dsp.dataset_presenter_id as dataset_id,
                      nvl(
                           nvl(
                           decode(dsp.subtype,  -- using terms defined in Ontology OBI
                                  'array','transcription profiling by array',
                                  'rnaseq','RNA-Seq',
                                  'chip_chip','ChIP-chip',
                                  'chipseq','ChIP-Seq',
                                  'rtpcr','transcription profiling by RT-PCR',
                                  'sage_tag','serial analysis of gene expression',
                                  'smallNcRna','RNA-Seq',
                                  'cgh_array','comparative genomic hybridization by array',
                                  'copyNumberVariation','copy number variation profiling',
                                  'originsOfReplication','DNA sequencing',
	                                'immune_response','proteomic profiling by array',
	                                '3k_chip','genotyping by SNP array',
                                  'HTS_SNP','genotyping by high throughput sequencing',
                                  'barcode','genotyping',
                                  'hd_array','genotyping by SNP array',
                                  'sequencing_typed','genotyping',
                                  'quantitative','mass spectrometry',
                                   null),
                           decode(dsp.type,
                                  'EST','EST sequencing', -- using terms defined in Experimental Factor Ontology (EFO)
                                 'SNP','genotyping',
                                 'protein_expression','mass spectrometry',
                                 'dbxref', 'Link Outs',
                                 null)
                            ),

                           decode(dsp.display_category,
                                'External Links','Link Outs',
                                'Genomes and Annotation: Microsatellite Markers','Microsatellite Markers',
                                'Genomes and Annotation: Genetic Map','Genetic Map',
                                'Genomes and Annotation: Old Annotations','Old Annotations',
                                'Genomes and Annotation: TF Binding Sites','TF Binding Sites',
                                'Genomes and Annotation:Organellar','Organellar',
                                null)
                      )
                      as exp_technique
                    from ApidbTuning.DatasetPresenter dsp
                  ]]>
            </sql>
      </sqlQuery>


      <sqlQuery name="Category" isCacheable="false">
         <column name="category"/>
         <column name="dataset_id"/>
         <sql>
           <![CDATA[
                   select dsp.dataset_presenter_id as dataset_id,
                           nvl(  -- dsp.display_category,
                               decode(dsp.display_category,
                                  'Comparative Genomics','Comparative Genomics',
                                  'Compounds and Metabolic Pathways','Compounds and Metabolic Pathways',
                                  'Compounds and Metabolic pathways','Compounds and Metabolic Pathways',
                                  --'External Links','External Links',
                                  'Function','Function',
                                  'Gene Expression: eQTL','Transcript Expression',
                                  'General','General',
                                  'Genomes and Annotation','Genomes and Annotation',
                                  'Genomes and Annotation: Genetic Map','Genomes and Annotation',
                                  'Genomes and Annotation: Microsatellite Markers','Genomes and Annotation',
                                  'Genomes and Annotation: Old Annotations','Genomes and Annotation',
                                  'Genomes and Annotation: TF Binding Sites','Genomes and Annotation',
                                  'Genomes and Annotation:Organellar','Genomes and Annotation',
                                  'Genomics','Comparative Genomics',
                                  'Host Response','Host Response',
                                  'Interactions and Cellular Location','Interactions and Cellular Location',
                                  'Ontology','Ontology',
                                  'Phenotype','Phenotype',
                                  'Population Biology','Population Biology',
                                  'Protein Expression','Protein Expression',
                                  'Protein Interactions','Protein Interactions',
                                  'Protein Structure','Protein Structure',
                                  'RNA Structure','RNA Structure',
                                  'Subcellular localization','Subcellular Localization',
                                  'Taxonomy and Phylogeny','Taxonomy and Phylogeny',
                                  'Transcript Expression','Transcript Expression',
                                   null),
                               decode(dsp.type,
                                      'epitope', 'Genomes and Annotation',
                                      -- 'dbxref', 'External Links',
                                      'isolates', 'Population Biology',
                                      'organellar_genome', 'Genomes and Annotation',
                                      'genome', 'Genomes and Annotation',
                                      'EST', 'Transcript Expression',
                                      'alias', 'Genomes and Annotation',
                                      'gene_annotation', 'Genomes and Annotation',
                                      'subcellular_localization', 'Subcellular Localization',
                                      -- 'aligned_sequence', 'Miscellaneous',
                                      'orthology', 'Taxonomy and Phylogeny',
                                      'function', 'Function',
                                      -- 'external_sequences', 'External Sequences',
                                      -- 'feature', 'Miscellaneous',
                                      'sres', 'Ontology',
                                      'transcript_expression', 'Transcript Expression',
                                      'transcript_expression_platform', 'Transcript Expression',
                                      'protein_expression', 'Protein Expression',
                                      'isolates', 'Population Biology',
                                      'SNP', 'Population Biology',
                                      'population_biology', 'Population Biology',
                                      'resequencing', 'Comparative Genomics',
				      'metabolite_levels', 'Metabolite Levels',
                                      null)
                                      ) as category
                    from ApidbTuning.DatasetPresenter dsp
                  ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="NewCategory" isCacheable="false">
         <column name="newcategory"/>
         <column name="dataset_id"/>
         <sql>
           <![CDATA[
                       select dsp.dataset_presenter_id as dataset_id,
                              nvl(dsp.display_category, dsp.category) as newcategory
                         from ApidbTuning.DatasetPresenter dsp
                ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="DatasetDigest" isCacheable="false" includeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
        <column name="dataset_sha1_digest"/>
        <column name="dataset_display_name"/>
        <column name="dataset_id"/>
          <sql>
            <![CDATA[
                       select dsp.dataset_sha1_digest
                         , dsp.dataset_presenter_id as dataset_id
                         , dsp.display_name as dataset_display_name
                       from ApidbTuning.DatasetPresenter dsp
                ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="ClinepiStudyAttributes"  isCacheable="false" includeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
         <column name="dataset_id"/>
         <column name="project_availability"/>
         <column name="study_access"/>
         <column name="policy_url"/>
         <column name="card_headline"/>
         <column name="card_points"/>
         <column name="card_questions"/>
         <column name="request_protection_level"/>
         <column name="request_access_fields"/>
         <column name="request_email"/>
         <column name="request_email_bcc"/>
         <column name="request_email_body"/>
         <column name="request_needs_approval"/>

            <sql>
            <![CDATA[
select pres.dataset_presenter_id as dataset_id,dp.project_availability, initcap(dp.study_access) as study_access,dp.policy_url, dp.card_headline, dp.card_points, card_questions, request_protection_level, request_access_fields, request_email, request_email_bcc, request_email_body, request_needs_approval
from apidbtuning.datasetpresenter pres, (
select * from (
select dataset_presenter_id, property, value
from apidbtuning.datasetproperty
where  property in ('studyCategories','projectAvailability','studyAccess','policyUrl','cardHeadline','cardPoints','cardQuestions','requestProtectionLevel','requestAccessFields','requestEmail', 'requestEmailBcc', 'requestEmailBody','requestNeedsApproval')
and trim(value) is not null
-- TEMPLATE_ANCHOR injectDatasetQuestions

-- TEMPLATE_ANCHOR injectProjectAvailability
)
pivot
(
   max(value)
   for property in ('projectAvailability' as project_availability,'studyAccess' as study_access,'policyUrl' as policy_url,'cardHeadline' as card_headline,'cardPoints' as card_points, 'cardQuestions' as card_questions, 'requestProtectionLevel' as request_protection_level, 'requestAccessFields' as request_access_fields, 'requestEmail' as request_email, 'requestEmailBcc' as request_email_bcc, 'requestEmailBody' as request_email_body, 'requestNeedsApproval' as request_needs_approval )
)) dp
where pres.dataset_presenter_id = dp.dataset_presenter_id(+)
            ]]>
            </sql>
      </sqlQuery>





      <sqlQuery name="MicrobiomeStudyAttributes"  isCacheable="false" includeProjects="MicrobiomeDB">
         <column name="dataset_id"/>
         <column name="study_categories"/>
            <sql>
            <![CDATA[
select pres.dataset_presenter_id as dataset_id, dp.study_categories
from apidbtuning.datasetpresenter pres, (
select * from (
select dataset_presenter_id, property, value
from apidbtuning.datasetproperty
where  property in ('studyCategories')
and trim(value) is not null
-- TEMPLATE_ANCHOR injectDatasetQuestions

-- TEMPLATE_ANCHOR injectProjectAvailability
)
pivot
(
   max(value)
   for property in ('studyCategories' as study_categories )
)) dp
where pres.dataset_presenter_id = dp.dataset_presenter_id(+)
            ]]>
            </sql>
      </sqlQuery>





      <sqlQuery name="StudyCharacteristic"  isCacheable="false" includeProjects="ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
        <column name="dataset_id"/>
        <column name="disease"/>
        <column name="sex"/>
	<column name="Sample_Type"/>
        <column name="Participant_Type"/>
        <column name="Study_Type"/>
        <column name="Study_Design"/>
	<column name="Country"/>
        <column name="Years"/>
        <column name="HH_count" columnType="number"/>
        <column name="Part_count" columnType="number"/>
        <column name="Obser_count" columnType="number"/>
        <column name="Samp_count" columnType="number"/>
        <column name="AdditionalData"/>
        <column name="Age"/>
        <column name="WHO"/>
        <column name="ProjectName"/>

        <sql>
          <![CDATA[

select mm.*,TRIM(TO_CHAR(counts.HH_count, '999,999,999,999,999')) HH_count , TRIM(TO_CHAR(counts.Part_count, '999,999,999,999,999')) Part_count , TRIM(TO_CHAR(counts.Obser_count, '999,999,999,999,999')) Obser_count, TRIM(TO_CHAR(counts.Samp_count, '999,999,999,999,999'))Samp_count
from (

  select pres.dataset_presenter_id as dataset_id, table2.disease, table2.sex, table2.Sample_Type, table2.Participant_Type, table2.Study_Type,table2.Study_Design,table2.Country, table2.Years, table2.AdditionalData ,table2.Age, table2.WHO,  table2.ProjectName
  from apidbtuning.datasetpresenter pres

left join

(WITH syn AS (
   SELECT s.ontology_term_id,  ot.source_id,  s.ontology_synonym as label
   FROM sres.ontologySynonym  s
   LEFT JOIN sres.ExternalDataBaseRelease edr ON s.external_database_release_ID = edr.external_database_release_ID
   LEFT JOIN sres.ExternaldataBase ed ON edr.external_database_id = ed.external_database_id
   LEFT JOIN sres.OntologyTerm ot ON s.ontology_term_id = ot.ontology_term_id
   WHERE ed.name = 'OntologyTerm_classifications_RSRC'
   ),
   val AS (SELECT * FROM syn),
   names AS (
     SELECT ed.name NAME, s1.study_id study_id, s1.external_database_release_id
       FROM study.study s1
       LEFT JOIN sres.EXTERNALDATABASERELEASE edr ON s1.EXTERNAL_DATABASE_RELEASE_ID=edr.EXTERNAL_DATABASE_RELEASE_ID
       LEFT JOIN sres.EXTERNALDATABASE ed ON edr.EXTERNAL_DATABASE_ID=ed.EXTERNAL_DATABASE_ID
       WHERE s1.STUDY_ID IN (SELECT s1.study_id FROM study.study s1
       LEFT JOIN study.study s0 ON s1.INVESTIGATION_ID=s0.STUDY_ID
       WHERE s0.STUDY_ID!=s1.STUDY_ID)
     union
     SELECT ed.name NAME, s1.study_id study_id, s1.external_database_release_id
       FROM study.study s1
       LEFT JOIN sres.EXTERNALDATABASERELEASE edr ON s1.EXTERNAL_DATABASE_RELEASE_ID=edr.EXTERNAL_DATABASE_RELEASE_ID
       LEFT JOIN sres.EXTERNALDATABASE ed ON edr.EXTERNAL_DATABASE_ID=ed.EXTERNAL_DATABASE_ID
       WHERE s1.STUDY_ID NOT IN (SELECT s1.study_id FROM study.study s1
       LEFT JOIN study.study s0 ON s1.INVESTIGATION_ID=s0.STUDY_ID
       WHERE s0.STUDY_ID!=s1.STUDY_ID)
       AND s1.STUDY_ID NOT IN (SELECT s0.study_id FROM study.study s1
       LEFT JOIN study.study s0 ON s1.INVESTIGATION_ID=s0.STUDY_ID
       WHERE s0.STUDY_ID!=s1.STUDY_ID)
     ),
   tableb AS (
     SELECT names.name, syn.source_id, syn.label,
     LISTAGG(ssc.value, ', ') WITHIN GROUP (ORDER BY ssc.study_id, ssc.qualifier_id) as raw_values,
     LISTAGG(val.label, ',') WITHIN GROUP (ORDER BY ssc.study_id, ssc.qualifier_id) as controlled_values,
     LISTAGG(val.source_id, ',') WITHIN GROUP (ORDER BY ssc.study_id,ssc.qualifier_id) as value_source_ids
     FROM study.StudyCharacteristic ssc
     LEFT JOIN names ON ssc.study_id = names.study_id
     LEFT JOIN syn ON ssc.qualifier_id = syn.ontology_term_id
     LEFT JOIN val ON ssc.value_id = val.ontology_term_id
     GROUP BY names.name, syn.source_id, syn.label
     )
  select * from (
  (select name, label , raw_values from tableb)
  )

pivot
  (
  max(raw_values)
  for label in ('Disease' as Disease,'Sample type' as Sample_Type,'Sex' as Sex,'Population included' as Participant_Type,'Investigation type' as Study_Type,'Study design' as Study_Design, 'Country' as Country, 'Years' as Years, 'Additional data' as AdditionalData, 'Age' as Age, 'WHO indicator subdomain' as WHO, 'Project name' as ProjectName)
  )
  ORDER BY name
  ) table2
  on pres.name = table2.name
) mm


left join

(select dataset_presenter_id, HH_count, Part_count, Obser_count, Samp_count from ApidbTuning.RecordCount
pivot
  (
  max(record_count)
  for record_type in ('Household' as HH_count,'Participant' as Part_count,'Observation' as Obser_count,'Sample' as Samp_count)
  )

ORDER BY dataset_presenter_id) counts

ON mm.dataset_id = counts.dataset_presenter_id
          ]]>
        </sql>
      </sqlQuery>




      <sqlQuery name="All"  isCacheable="false">
         <column name="dataset_id"/>
         <column name="dataset_name"/>
         <column name="dataset_name_pattern"/>
         <column name="display_name" ignoreCase="true"/>
         <column name="short_display_name"/>
         <column name="description"/>
         <column name="version"/>
         <column name="summary"/>
         <column name="protocol"/>
         <column name="usage"/>
         <column name="caveat"/>
         <column name="acknowledgement"/>
         <column name="release_policy"/>
         <column name="type"/>
         <column name="is_species_scope"/>
         <column name="build_number_introduced"/>
         <column name="eupath_release" sortingColumn="build_number_introduced"/>
         <column name="pmids"/>
         <column name="pmids_download"/>
         <sql>
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                   dsp.name as dataset_name, dsp.dataset_name_pattern,
                   dsp.display_name, ds.version,
                   dsp.short_display_name, dsp.description,
                   nvl(dsp.summary, dsp.description) as summary,
                   dsp.protocol, dsp.usage, dsp.caveat, dsp.acknowledgement,
                   dsp.release_policy, dsp.type,
                   dsp.is_species_scope,
                   dsp.build_number_introduced,
                   nvl(history.eupath_release, introduced.eupath_release) as eupath_release,
                   pubs.pmids,
                   pubs.pmids_download
            from apidbTuning.DatasetPresenter dsp, apidb.datasource ds,
                 (select dataset_presenter_id,
                         listagg('<a href="https://www.ncbi.nlm.nih.gov/pubmed/' || pmid || '">' || pmid || '</a>', ', ') within group (order by pmid) as pmids,
                         listagg('https://www.ncbi.nlm.nih.gov/pubmed/' || pmid, ', ') within group (order by pmid) as pmids_download
                  from ApidbTuning.DatasetPublication
                  group by dataset_presenter_id) pubs,
                 (select dataset_presenter_id,
                         'release ' || release_number || ' / ' || release_date as eupath_release
                  from (select dh.dataset_presenter_id, dh.build_number, ebd.release_date,
                               ebd.release_number, ebd.project,
                               row_number() over (partition by dh.dataset_presenter_id
                                                              order by ebd.release_number desc) rn
                        from apidbTuning.DatasetHistory dh, apidbTuning.EupathBuildDates ebd
                        where dh.build_number = ebd.build_number
                          and ebd.project = '@PROJECT_ID@')
                  where rn = 1) history,
                 (select build_number,
                         'release ' || release_number || ' / ' || release_date as eupath_release
                  from apidbTuning.EupathBuildDates
                        where project = '@PROJECT_ID@') introduced
            where dsp.dataset_presenter_id = history.dataset_presenter_id(+)
              and dsp.build_number_introduced = introduced.build_number(+)
              and dsp.dataset_presenter_id = pubs.dataset_presenter_id(+)
	      and ds.name (+) = dsp.name
            ]]>
         </sql>
      </sqlQuery>



      <sqlQuery name="Contacts"  isCacheable="false">
	<column name="dataset_id"/>
	<column name="contact"/>
        <column name="institution"/>
        <column name="email"/>
        <column name="short_attribution"/>
            <sql>
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                   CASE WHEN  dsc.name is not null THEN dsc.name
                        WHEN dsc.affiliation is not null THEN dsc.affiliation
                        ELSE '<a href="http://eupathdb.org/eupathdb/app/contact-us" class="new-window" data-name="contact_us">Contact VEuPathDB for more details</a>'
                   END as contact,
                   CASE WHEN  (dsc.name is null and dsc.affiliation is not null) THEN dsc.name
                        ELSE   dsc.affiliation END as institution,
                   dsc.email as email,
                   nvl(dsp.short_attribution, dsc.name) as short_attribution
            from ApidbTuning.DatasetPresenter dsp, ApidbTuning.DatasetContact dsc
            where dsp.dataset_presenter_id = dsc.dataset_presenter_id (+)
            and dsc.is_primary_contact = 1
 ]]>
            </sql>
      </sqlQuery>



    <sqlQuery name="Projects"  isCacheable="false">
        <column name="dataset_id"/>
        <column name="project_id"/>


            <sql>
            <![CDATA[
               WITH projprop AS (
                 SELECT dataset_presenter_id, value as project
                 FROM apidbTuning.DatasetProperty
                 WHERE property = 'projectName')
               SELECT dsp.dataset_presenter_id as dataset_id, dsp.name,
                      CASE WHEN (dp.project IS NOT NULL) THEN dp.project
                           ELSE '' END  as project_id
               FROM apidbTuning.DatasetPresenter dsp, apidb.Datasource ds,
                    projprop dp
               WHERE ds.name (+) = dsp.name
               AND dsp.dataset_presenter_id = dp.dataset_presenter_id(+)

               select dsp.dataset_presenter_id as dataset_id,
                      dp.value as project_id
                 from apidbTuning.DatasetPresenter dsp, apidb.Datasource ds,
                      apidbTuning.DatasetProperty dp
                where ds.name (+) = dsp.name
                  and dsp.dataset_presenter_id = dp.dataset_presenter_id
                  and dp.property = 'projectName'
            ]]>
            </sql>
    </sqlQuery>


      <sqlQuery name="Organisms"  isCacheable="false">
        <column name="dataset_id"/>
        <column name="organism_prefix"/>
 
            <sql excludeProjects="EuPathDB">
            <![CDATA[
select dataset_id,
  regexp_replace(
    utl_i18n.unescape_reference(to_char( dbms_lob.substr(xmlagg(xmlelement(e,org,'<br>').extract('//text()')  order by org).getclobval() , 4000, 1)) ) , '<br>[A-Za-z\. <>&]+$', '<br>...') AS organism_prefix
from (
select distinct dsnt.dataset_presenter_id as dataset_id
 , case when tn.name is null then null
        else '<i>' || substr(tn.name, 0, instr(tn.name, ' ', 1, 2) -1) || '</i>' || substr(tn.name, instr(tn.name, ' ', 1, 2))
         end as org
from apidbtuning.datasetnametaxon dsnt
 , sres.taxonname tn
 where dsnt.taxon_id = tn.taxon_id (+)
 and tn.name_class (+) = 'scientific name'
 )
 group by dataset_id
            ]]>
            </sql>

           <sql includeProjects="EuPathDB">
            <![CDATA[
          select distinct dataset_id, expects_multiple,
                  case when organism_count = 1 and oa.organism_name is not null and expects_multiple = 0
                       then '<i>' || substr(oa.organism_name, 0, instr(oa.organism_name, ' ', 1, 2) -1) || '</i>' || substr(oa.organism_name, instr(oa.organism_name, ' ', 1, 2))
                       when expects_multiple=1 and organism_count > 1 and (regexp_count(oa.organism_name, substr(oa.organism_name, 0, instr(oa.organism_name, ' ', 1, 2)))) = organism_count
                       then '<i>' || substr(oa.organism_name, 1, 1) || '.' ||
                                     substr(oa.organism_name, instr(oa.organism_name, ' ', 1, 1), decode(instr(oa.organism_name, ' ', 1, 2), 0, length(oa.organism_name) + 1, instr(oa.organism_name, ' ', 1, 2)) - instr(oa.organism_name, ' ', 1, 1)) || '</i>'
                       when expects_multiple > 0
                       then 'multiple organisms'
                       else 'undetermined' end as organism_prefix
           from (
                select dsp.dataset_presenter_id as dataset_id, dsp.type,
                     count(distinct dsnt.taxon_id) as organism_count,
                     -- if the dataset_name_pattern starts w/ a % we won't append an organism prefix to the datasetDisplayName
                     case when substr(dsp.dataset_name_pattern, 0, 1) = '%' or (dsp.type = 'isolates' and dsp.subtype = 'sequencing_typed')
                      then 1
                      else 0
                      end as expects_multiple
                 from ApidbTuning.DatasetPresenter dsp, ApidbTuning.DatasetNameTaxon dsnt
                where dsp.dataset_presenter_id = dsnt.dataset_presenter_id (+)
                group by dsp.type, dsp.subtype, dsp.dataset_presenter_id, dsp.dataset_name_pattern
               ) dsp, 
              ApidbTuning.DatasetNameTaxon dsnt, apidbtuning.OrganismAttributes oa
          where dsp.dataset_id = dsnt.dataset_presenter_id (+)
            and dsnt.taxon_id = oa.component_taxon_id (+)
            and  dsnt.name like oa.public_abbrev || '%'
            ]]>
            </sql>
      </sqlQuery>

    </querySet>

      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Table queries -->
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetTables" queryType="table"
              isCacheable='false'>

      <sqlQuery name="Publications"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="pmid"/>
            <column name="citation"/>
            <sql>
            <![CDATA[
             select dataset_presenter_id as dataset_id, pmid, citation
             from ApidbTuning.DatasetPublication
             where pmid is not null
             order by dataset_publication_id
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="History"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="build"/>
            <column name="release_date"/>
            <column name="note"/>
            <sql>
            <![CDATA[
             select dh.dataset_presenter_id as dataset_id, bd.build_number as build, bd.release_date, dh.note
             from ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd
             where dh.build_number = bd.build_number
               and bd.project = '@PROJECT_ID@'
             order by bd.build_number
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="GenomeHistory"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="build"/>
            <column name="release_date"/>
            <column name="project"/>
            <column name="release_number"/>
            <column name="genome_source"/>
            <column name="genome_version"/>
            <column name="annotation_source"/>
            <column name="annotation_version"/>
            <column name="functional_annotation_source"/>
            <column name="functional_annotation_version"/>
            <column name="note"/>
            <sql>
            <![CDATA[
             select dh.dataset_presenter_id as dataset_id, bd.build_number as build, to_char(bd.release_date, 'yyyy-mm-dd') as release_date,
                    bd.project, bd.release_number, dh.genome_source,
	                  dh.genome_version, dh.annotation_source, dh.annotation_version,
                    dh.functional_annotation_source, dh.functional_annotation_version,dh.note
             from ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd
             where dh.build_number = bd.build_number
               and bd.project = '@PROJECT_ID@'
             order by bd.build_number
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="Contacts"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="contact_name"/>
            <column name="affiliation"/>
            <sql>
            <![CDATA[
                     select dsp.name as dataset_name, dsp.dataset_presenter_id as dataset_id,
                            dsc.name as contact_name, dsc.affiliation
                     from ApidbTuning.DatasetPresenter dsp, ApidbTuning.DatasetContact dsc
                     where dsp.dataset_presenter_id = dsc.dataset_presenter_id
                     order by dsc.is_primary_contact desc, dsc.dataset_contact_id asc
            ]]>
            </sql>
      </sqlQuery>


<!--
<sqlQuery name="DownloadVersion" isCacheable='false' includeProjects="ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="release_date"/>
            <column name="version_number"/>
            <column name="note"/>
            <column name="dataset_sha1_digest"/>
            <column name="build_number"/>
            <sql>
            <![CDATA[                                                                                                          
SELECT dataset_name, dataset_id, build_number, release_date , 'Version ' || ROW_NUMBER() OVER (PARTITION BY dataset_id ORDER BY dataset_id, build_number) as version_number, note, dataset_sha1_digest                                                                
FROM (                                                                                                                          
   SELECT distinct dh.dataset_presenter_id as dataset_id, dp.name as dataset_name, TO_CHAR(bd.release_date, 'YYYY-MM-DD') as release_date, dh.note, dp.dataset_sha1_digest , dh.build_number                                                 
   FROM  ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd,  ApidbTuning.DatasetPresenter dp                        
   WHERE dh.build_number = bd.build_number                                                                                       
   AND  dh.dataset_presenter_id = dp.dataset_presenter_id                                                                        
   ORDER by dh.build_number                                                                                                      
   ) ORDER by build_number                                                                                                       
            
	    ]]>
        </sql>
</sqlQuery>
-->



      <sqlQuery name="AccessRequest"  isCacheable="false" includeProjects="ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
	    <column name="dataset_id"/>
	    <column name="dataset_name"/>
            <column name="name"/>
            <column name="organization"/>
	    <column name="start_date"/>
	    <column name="purpose"/>
            <sql>
              <![CDATA[
SELECT t1.name,t2.value as organization, to_char(CAST(t3.start_date AS DATE) , 'YYYY-MM-DD' ) as start_date, t3.purpose,t4.dataset_presenter_id as dataset_id, t4.name as dataset_name
FROM (
    SELECT user_id, listagg(value,' ') within group( order by key ) as name
    FROM (
         SELECT *
         FROM(
             SELECT user_id, key, value
             FROM @ACCT_SCHEMA@account_properties@ACCT_DBLINK@ where key in ('first_name', 'last_name')
         )
     )
    GROUP BY user_id
 )t1,
(SELECT user_id, value
   FROM @ACCT_SCHEMA@account_properties@ACCT_DBLINK@
  WHERE key in ('organization'))t2,
(SELECT user_id, dataset_presenter_id, start_date, purpose, a.name AS approval_status
   FROM studyaccess.end_users@ACCT_DBLINK@ v
     INNER JOIN studyaccess.approval_status@ACCT_DBLINK@ a
       ON v.approval_status_id = a.approval_status_id
  WHERE purpose is not NULL
    AND a.name = 'approved')t3,
(SELECT dataset_presenter_id, name FROM apidbtuning.datasetpresenter)t4
WHERE t1.user_id = t2.user_id and t1.user_id=t3.user_id  and t3.dataset_presenter_id  = t4.dataset_presenter_id
ORDER by start_date desc

 ]]>

            </sql>
      </sqlQuery>




      <sqlQuery name="Isolates"  isCacheable='false' excludeProjects="MicrobiomeDB">
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="source_id"/>
            <column name="strain"/>
            <column name="contact_name"/>
            <sql excludeProjects="Piroplasma,EuPathDB">
            <![CDATA[
                     select ia.source_id,
                     ia.project_id,
                     ds.name as dataset_name,
                     iads.dataset_presenter_id as dataset_id,
                     ia.strain,
                     listagg(iac.name, ',') within group (order by iac.name) as contact_name
                     from study.Study s, apidb.Datasource ds, sres.ExternalDatabase d,
                          sres.ExternalDatabaseRelease r, rad.StudyBiomaterial sb,
                          ApidbTuning.PopsetAttributes ia,
                          ApidbTuning.DatasetNameTaxon iads,
                          ApidbTuning.DatasetContact iac
                     where s.external_database_release_id = r.external_database_release_id
                     and r.external_database_id = d.external_database_id
                     and ds.name = d.name
                     and ds.version = r.version
                     and s.study_id = sb.study_id
                     and sb.bio_material_id = ia.bio_material_id
                     and ia.experiment_external_db_name = iads.name
                     and iads.dataset_presenter_id = iac.dataset_presenter_id (+)
                     group by iads.dataset_presenter_id, ia.source_id, ia.project_id, ds.name, ia.strain
            ]]>
            </sql>
            <sql includeProjects="EuPathDB">
            <![CDATA[
                     select '' as source_id,
                     '' as project_id,
                     name as dataset_name,
                     dataset_presenter_id as dataset_id,
                     '' as strain,
                     '' as  contact_name
                     from ApidbTuning.DatasetPresenter ds
                     where ds.name = 'no isolates for portal'
            ]]>
            </sql>

      </sqlQuery>



      <sqlQuery name="HyperLinks"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="text"/>
            <column name="url"/>
            <column name="description"/>
            <sql excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
              SELECT dataset_id, text, url, description
              FROM ApidbTuning.DatasetHyperLinks
            </sql>


            <sql includeProjects="MicrobiomeDB,ClinEpiDB,Gates,AllClinEpiDB,ICEMR">
              SELECT dataset_presenter_id AS dataset_id, text, url, description
              FROM ApidbTuning.DatasetHyperLINK
            </sql>


            <sql includeProjects="EuPathDB">
              SELECT dataset_id, text, url, description
              FROM ApidbTuning.DatasetHyperLinks
              WHERE url NOT LIKE '%/jbrowse%'
            </sql>
      </sqlQuery>


      <sqlQuery name="References"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="record_type"/>
            <column name="target_type"/>
            <column name="target_name"/>
            <sql>
            <![CDATA[
                     select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, ref.record_type, ref.target_type,
                     replace (ref.target_name, ':', '') as target_name
                     from ApidbTuning.datasetmodelref ref, ApidbTuning.DatasetPresenter dsp
                     where dsp.dataset_presenter_id = ref.dataset_presenter_id
                    order by dsp.name, ref.target_type, ref.record_type, ref.target_name
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="Version"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="version"/>
            <column name="organism"/>
            <sql excludeProjects="EuPathDB">
            <![CDATA[
                    with TaxonScientificName as (
                    select taxon_id,name
                    from sres.taxonname where
                    name_class = 'scientific name')
                    select dataset_name, dataset_id,organism, version from (
                      select distinct dnt.name as dataset_name,
                           dnt.dataset_presenter_id as dataset_id,
                           case when dnt.taxon_id = 0
                           then 'ALL'
                           else tn.name
                           end as organism,
                            replace (ds.version, '_gus4','') as version
                      from TaxonScientificName tn, ApidbTuning.DatasetNameTaxon dnt,
                          apidb.datasource ds
                      where dnt.taxon_id = tn.taxon_id(+)
                      and   ds.name = dnt.name
                      order by dnt.name
                    )

            ]]>
            </sql>
            <sql includeProjects="EuPathDB">
              select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, '' as version, '' as organism
              from ApidbTuning.DatasetPresenter dsp
              where dsp.name = 'no version for portal'
            </sql>
      </sqlQuery>





      <sqlQuery name="ExampleGraphs">
            <column name="source_id" />
            <column name="project_id" />
            <column name="graph_ids" />
            <column name="default_graph_id" />
            <column name="module" />
            <column name="mainOpen" />
            <column name="dataOpen" />
            <column name="display_name" />
            <column name="description" />
            <column name="x_axis" />
            <column name="y_axis" />
            <column name="has_graph_data"/>
	    <column name="has_meta_data"/>
	    <column name="meta_data_categories"/>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="is_graph_custom"/>
            <column name="assay_type"/>
            <column name="template"/>

            <!-- force no plots on dataset record while avoiding datasetexamplesourceid for mbio, clinepi-->
            <sql includeProjects="EuPathDB, MicrobiomeDB, ClinEpiDB, AllClinEpiDB">
            <![CDATA[
 select '' as source_id,
            '' as project_id,
            '' as graph_ids,
            '' as default_graph_id,
            '' as module,
            '' as mainOpen,
            '' as dataOpen,
            '' as display_name,
            '' as description,
            '' as x_axis,
            '' as y_axis,
            '' as has_graph_data,
            '' as has_meta_data,
            '' as meta_data_categories,
            '' as is_graph_custom,
            '' as summary,
            '' as short_attribution,
            '' as assay_type,
            '' as template,
                     name as dataset_name,
                     dataset_presenter_id as dataset_id
                     from ApidbTuning.DatasetPresenter ds
                     where ds.name = 'no graphs for portal'

            ]]>
            </sql>

            <sql excludeProjects="EuPathDB, MicrobiomeDB, ClinEpiDB, AllClinEpiDB">
            <![CDATA[

select g.*, decode(lower(is_graph_custom), 'false', 1, 0) as template, regexp_substr(graph_ids, '[^,]*') as default_graph_id
from (
select
p.example_source_id as source_id,
       '@PROJECT_ID@' as project_id,
       graph_descrip.dataset as dataset_name,
       p.example_source_id as graph_ids,
       dnt.dataset_presenter_id as dataset_id,
       '1' as has_graph_data,
       'FALSE' as has_meta_data,
       '' as graph_organism,
       'TRUE' as mainOpen,
       'FALSE' as dataOpen,
       '' as meta_data_categories,
       graph_descrip.*--,

from (

select '' as dataset,
       '' as display_name,
       '' as description,
       '' as module,
       '' as x_axis,
       '' y_axis,
       '' as is_graph_custom,
       'other' as assay_type,
       1 as order_num

       from dual
      -- TEMPLATE_ANCHOR datasetExampleGraphDescriptions
       ) graph_descrip, ApidbTuning.datasetexamplesourceid p,
       ApidbTuning.datasetnametaxon dnt
where p.dataset = graph_descrip.dataset
and graph_descrip.dataset = dnt.name) g
             ]]>
            </sql>
      </sqlQuery>

<!--
      <sqlQuery name="DatasetGeneTable"  isCacheable='false'>
        <column name="dataset_id"/>
        <column name="source_id"/>
        <column name="fdiff"/>
        <column name="min_value"/>
        <column name="min_timepoint"/>
        <column name="max_value"/>
        <column name="max_timepoint"/>
        <sql>
        <![CDATA[
          select dataset_presenter_id as dataset_id, dataset_name, source_id,
                 fdiff, min_value, min_timepoint, max_value, max_timepoint
          from ApidbTuning.DatasetGeneList
        ]]>
       </sql>
      </sqlQuery>
-->
    </querySet>

    <querySet name="DatasetReleaseNotesTables" queryType="table"
              isCacheable='false'>


      <sqlQuery name="ReleaseNotes"  isCacheable='false'>
            <column name="release_notes_id"/>
            <column name="build_number"/>
            <column name="release_date"/>
            <column name="dataset_id"/>
            <column name="dataset_name"/>
            <column name="note"/>
            <sql>
            <![CDATA[
             select '111' as release_notes_id, bd.build_number, bd.release_date,
                    dh.dataset_presenter_id as dataset_id, dp.name as dataset_name, dh.note
             from ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd,
                  ApidbTuning.DatasetPresenter dp
             where dh.build_number = bd.build_number
             and dh.dataset_presenter_id = dp.dataset_presenter_id
             order by dh.build_number
            ]]>
            </sql>
      </sqlQuery>

    </querySet>

</wdkModel>
